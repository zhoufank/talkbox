<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=11; IE=10; IE=9; IE=8; IE=7; IE=EDGE" />
        <title>Snax | skynet入门实践</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.5.0">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
        
    
    
    <link rel="next" href="../skynetwiki/SocketChannel.html" />
    
    
    <link rel="prev" href="../skynetwiki/ShareData.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book" data-level="2.22" data-basepath=".." data-revision="1422694045002">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduction
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="skynet/README.html">
            
                
                    <a href="../skynet/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         skynet介绍
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.1" data-path="skynet/install.html">
            
                
                    <a href="../skynet/install.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                         skynet安装
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2" data-path="skynet/structure.html">
            
                
                    <a href="../skynet/structure.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                         skynet目录结构
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.3" data-path="skynet/logic.html">
            
                
                    <a href="../skynet/logic.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                         skynet工作逻辑
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.4" data-path="skynet/server.html">
            
                
                    <a href="../skynet/server.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                         skynet服务管理
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.5" data-path="skynet/queue.html">
            
                
                    <a href="../skynet/queue.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                         skynet消息队列
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.6" data-path="skynet/socket.html">
            
                
                    <a href="../skynet/socket.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.6.</b>
                        
                         skynet数据接收处理
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.7" data-path="skynet/module.html">
            
                
                    <a href="../skynet/module.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.7.</b>
                        
                         skynet模块
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.8" data-path="skynet/logger.html">
            
                
                    <a href="../skynet/logger.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.8.</b>
                        
                         从logger模块说起
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.9" data-path="skynet/masterANDharbor.html">
            
                
                    <a href="../skynet/masterANDharbor.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.9.</b>
                        
                         master和harbor模块
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.10" data-path="skynet/snlua.html">
            
                
                    <a href="../skynet/snlua.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.10.</b>
                        
                         snlua模块
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.11" data-path="skynet/luaapi.html">
            
                
                    <a href="../skynet/luaapi.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.11.</b>
                        
                         snlua提供lua api的模块接口
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.12" data-path="skynet/luamodule.html">
            
                
                    <a href="../skynet/luamodule.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.12.</b>
                        
                         lua形式的模块
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="skynet/skynetwiki.html">
            
                
                    <a href="../skynet/skynetwiki.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         skynet wiki
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="2.1" data-path="skynetwiki/Blogs.html">
            
                
                    <a href="../skynetwiki/Blogs.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                         Blogs
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.2" data-path="skynetwiki/Bootstrap.html">
            
                
                    <a href="../skynetwiki/Bootstrap.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                         Bootstrap
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.3" data-path="skynetwiki/Build.html">
            
                
                    <a href="../skynetwiki/Build.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                         Build
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.4" data-path="skynetwiki/Centos 6.x 下编译Skynet 需要安装的依赖.html">
            
                
                    <a href="../skynetwiki/Centos 6.x 下编译Skynet 需要安装的依赖.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.4.</b>
                        
                         Centos 6.x 下编译Skynet 需要安装的依赖
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.5" data-path="skynetwiki/Cluster.html">
            
                
                    <a href="../skynetwiki/Cluster.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.5.</b>
                        
                         Cluster
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.6" data-path="skynetwiki/CodeCache.html">
            
                
                    <a href="../skynetwiki/CodeCache.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.6.</b>
                        
                         CodeCache
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.7" data-path="skynetwiki/Community.html">
            
                
                    <a href="../skynetwiki/Community.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.7.</b>
                        
                         Community
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.8" data-path="skynetwiki/Config.html">
            
                
                    <a href="../skynetwiki/Config.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.8.</b>
                        
                         Config
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.9" data-path="skynetwiki/DataCenter.html">
            
                
                    <a href="../skynetwiki/DataCenter.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.9.</b>
                        
                         DataCenter
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.10" data-path="skynetwiki/FAQ.html">
            
                
                    <a href="../skynetwiki/FAQ.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.10.</b>
                        
                         FAQ
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.11" data-path="skynetwiki/GateServer.html">
            
                
                    <a href="../skynetwiki/GateServer.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.11.</b>
                        
                         GateServer
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.12" data-path="skynetwiki/Home.html">
            
                
                    <a href="../skynetwiki/Home.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.12.</b>
                        
                         Home
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.13" data-path="skynetwiki/Http.html">
            
                
                    <a href="../skynetwiki/Http.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.13.</b>
                        
                         Http
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.14" data-path="skynetwiki/LoginServer.html">
            
                
                    <a href="../skynetwiki/LoginServer.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.14.</b>
                        
                         LoginServer
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.15" data-path="skynetwiki/LuaAPI.html">
            
                
                    <a href="../skynetwiki/LuaAPI.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.15.</b>
                        
                         LuaAPI
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.16" data-path="skynetwiki/MsgServer.html">
            
                
                    <a href="../skynetwiki/MsgServer.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.16.</b>
                        
                         MsgServer
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.17" data-path="skynetwiki/Multicast.html">
            
                
                    <a href="../skynetwiki/Multicast.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.17.</b>
                        
                         Multicast
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.18" data-path="skynetwiki/MySQL.html">
            
                
                    <a href="../skynetwiki/MySQL.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.18.</b>
                        
                         MySQL
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.19" data-path="skynetwiki/Profile.html">
            
                
                    <a href="../skynetwiki/Profile.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.19.</b>
                        
                         Profile
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.20" data-path="skynetwiki/Queue.html">
            
                
                    <a href="../skynetwiki/Queue.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.20.</b>
                        
                         Queue
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.21" data-path="skynetwiki/ShareData.html">
            
                
                    <a href="../skynetwiki/ShareData.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.21.</b>
                        
                         ShareData
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="2.22" data-path="skynetwiki/Snax.html">
            
                
                    <a href="../skynetwiki/Snax.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.22.</b>
                        
                         Snax
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.23" data-path="skynetwiki/SocketChannel.html">
            
                
                    <a href="../skynetwiki/SocketChannel.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.23.</b>
                        
                         SocketChannel
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.24" data-path="skynetwiki/Socket.html">
            
                
                    <a href="../skynetwiki/Socket.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.24.</b>
                        
                         Socket
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.25" data-path="skynetwiki/UniqueService.html">
            
                
                    <a href="../skynetwiki/UniqueService.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.25.</b>
                        
                         UniqueService
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.26" data-path="skynetwiki/Uses.html">
            
                
                    <a href="../skynetwiki/Uses.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.26.</b>
                        
                         Uses
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="talkbox/README.html">
            
                
                    <a href="../talkbox/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         talkbox例子
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.1" data-path="talkbox/about.html">
            
                
                    <a href="../talkbox/about.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                         talkbox介绍
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.2" data-path="talkbox/install.html">
            
                
                    <a href="../talkbox/install.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                         talkbox服务端的安装和客户端的使用
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.3" data-path="talkbox/listen.html">
            
                
                    <a href="../talkbox/listen.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                         talkbox监听获取
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.4" data-path="talkbox/logic.html">
            
                
                    <a href="../talkbox/logic.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.</b>
                        
                         talkbox逻辑结构
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="4" data-path="other/README.html">
            
                
                    <a href="../other/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                         其他
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="4.1" data-path="other/reference.html">
            
                
                    <a href="../other/reference.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                         学习参考资料
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4.2" data-path="other/protobuf.html">
            
                
                    <a href="../other/protobuf.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.2.</b>
                        
                         protobuf
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4.3" data-path="other/lua53.html">
            
                
                    <a href="../other/lua53.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.3.</b>
                        
                         Lua 5.3 参考手册
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="5" data-path="end/README.html">
            
                
                    <a href="../end/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                         结束
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >skynet入门实践</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_44">
                    
                        <p>snax 是一个方便 skynet 服务实现的简单框架。（简单是相对于 skynet 的 api 而言）</p>
<p>使用 snax 服务先要在 [[Config]] 中配置 snax 用于路径查找。每个 snax 服务都有一个用于启动服务的名字，推荐按 lua 的模块命名规则，但目前不推荐在服务名中包含&quot;点&quot; （在路径搜索上尚未支持 . 与 / 的替换）。在启动服务时会按查找路径搜索对应的文件。</p>
<p>snax 服务用 lua 编写，但并不是一个独立的 lua 程序。它里面包含了一组 lua 函数，会被 snax 框架分析加载。</p>
<p>test/pingserver.lua 就是一个简单的 snax 服务范例：</p>
<pre><code class="lang-lua"><span class="hljs-keyword">local</span> skynet = <span class="hljs-built_in">require</span> <span class="hljs-string">"skynet"</span>

<span class="hljs-keyword">local</span> i = <span class="hljs-number">0</span>
<span class="hljs-keyword">local</span> hello = <span class="hljs-string">"hello"</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">response.ping</span><span class="hljs-params">(hello)</span></span>
    skynet.sleep(<span class="hljs-number">100</span>)
    <span class="hljs-keyword">return</span> hello
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">accept.hello</span><span class="hljs-params">()</span></span>
    i = i + <span class="hljs-number">1</span>
    <span class="hljs-built_in">print</span> (i, hello)
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">response.error</span><span class="hljs-params">()</span></span>
    <span class="hljs-built_in">error</span> <span class="hljs-string">"throw an error"</span>
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span><span class="hljs-params">( ... )</span></span>
    <span class="hljs-built_in">print</span> (<span class="hljs-string">"ping server start:"</span>, ...)
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exit</span><span class="hljs-params">(...)</span></span>
    <span class="hljs-built_in">print</span> (<span class="hljs-string">"ping server exit:"</span>, ...)
<span class="hljs-keyword">end</span>
</code></pre>
<h2 id="snax-">snax 服务的启动和退出</h2>
<p>每个 snax 服务中都需要定义一个 <strong>init</strong> 函数，启动这个服务会调用这个函数，并把启动参数传给它。</p>
<p>snax 服务还可以定义一个 <strong>exit</strong> 函数用于响应服务退出的事件，同样能接收一些参数。</p>
<p>和标准的 skynet 服务不同，这些参数的类型不受限制，可以是 lua 的复杂数据类型。（而 skynet 服务受底层限制，只可以接受字符串参数）</p>
<p>启动一个 snax 服务有三种方式：</p>
<pre><code class="lang-lua"><span class="hljs-keyword">local</span> snax = <span class="hljs-built_in">require</span> <span class="hljs-string">"snax"</span>
</code></pre>
<ol>
<li><p><strong>snax.newservice(name, ...)</strong> ：可以把一个服务启动多份。传入服务名和参数，它会返回一个对象，用于和这个启动的服务交互。如果多次调用 newservice ，即使名字相同，也会生成多份服务的实例，它们各自独立，由不同的对象区分。</p>
</li>
<li><p><strong>snax.uniqueservice(name, ...)</strong> : 和上面 api 类似，但在一个节点上只会启动一份同名服务。如果你多次调用它，会返回相同的对象。</p>
</li>
<li><p><strong>snax.globalservice(name, ...)</strong> : 和上面的 api 类似，但在整个 skynet 网络中（如果你启动了多个节点），只会有一个同名服务。</p>
</li>
</ol>
<p>前一种方式可以看成是启动了一个匿名服务，启动后只能用地址（以及对服务地址的对象封装）与之通讯；后两种方式都可以看成是具名服务，之后可以用名字找到它。</p>
<p>后两种方式是对具名服务惰性初始化。如果你在代码中写了多处服务启动，第一次会生效，后续只是对前面启动的服务的查询。往往我们希望明确服务的启动流程（在启动脚本里就把它们启动好）；尤其是全局（整个 skynet 网络可见）的服务，我们还希望明确它启动在哪个结点上（如果是惰性启动，你可能无法预知哪个节点先把这个服务启动起来的）。这时，可以使用下面两个 api ：</p>
<ol>
<li><p><strong>snax.queryservice(name)</strong> ：查询当前节点的具名服务，返回一个服务对象。如果服务尚未启动，那么一直阻塞等待它启动完毕。</p>
</li>
<li><p><strong>snax.queryglobal(name)</strong> ：查询一个全局名字的服务，返回一个服务对象。如果服务尚未启动，那么一直阻塞等待它启动完毕。</p>
</li>
</ol>
<p>对于匿名服务，你无法在别处通过名字得到和它交互的对象。如果你有这个需求，可以把对象的 <strong>.handle</strong> 域通过消息发送给别人。 handle 是一个数字，即 snax 服务的 skynet 服务地址。</p>
<p>这个数字的接收方可以通过 <strong>snax.bind(handle, typename)</strong> 把它转换成服务对象。这里第二个参数需要传入服务的启动名，以用来了解这个服务有哪些远程方法可以供调用。当然，你也可以直接把 <strong>.type</strong> 域和 <strong>.handle</strong> 一起发送过去，而不必在源代码上约定。</p>
<p>如果你想让一个 snax 服务退出，调用 <strong>snax.kill(obj, ...)</strong> 即可。</p>
<p><strong>snax.self()</strong> 用来获取自己这个服务对象，它等价于 snax.bind(skynet.self(), SERVER_NAME)</p>
<p><strong>snax.exit(...)</strong> 退出当前服务，它等价于 snax.kill(snax.self(), ...) 。</p>
<p>注：snax 的接口约定是通过分析对应的 lua 源文件完成的。所以无论是消息发送方还是消息接收方都必须可以读到其消息处理的源文件。不仅 snax.newservice 会加载对应的源文件生成新的服务；调用者本身也会在自身的 lua 虚拟机内加载对应的 lua 文件做一次分析；同样， snax.bind 也会按 typename 分析对应的源文件。</p>
<h2 id="rpc-">RPC 调用</h2>
<p>snax 服务中可以定义一组函数用于响应其它服务提出的请求，并给出（或不给出）回应。一个非 snax 服务也可以调用 snax 服务的远程方法。</p>
<p>要定义这类远程方法，可以通过定义 <strong>function response.foobar(...)</strong> 来声明一个远程方法。foobar 是方法名，<strong>response</strong> 前缀表示这个方法一定有一个回应。你可以通过函数返回值来回应远程调用。</p>
<p>调用这个远程方法，可以通过 <strong>obj.req.foobar(...)</strong> 来调用它。obj 是服务对象，req 表示这个调用需要接收返回值。foobar 是方法的名字。其实，在创建出 obj 对象时，框架已经了解了这个 foobar 方法有返回值，这里多此一举让使用者明确 req 类型是为了让调用者（以及潜在的代码维护者）清楚这次调用是阻塞的，会导致服务挂起，等待对方的回应。</p>
<p>如果你设计的协议不需要返回值，那么可以通过定义 <strong>function accept.foobar(...)</strong> 来声明。这里可以有和 response 组相同的方法名。通过 <strong>accept</strong> 前缀来区分 <strong>response</strong> 组下同名的方法。这类方法的实现函数不可以有返回值。</p>
<p>调用这类不需要返回值的远程方法，应该使用 <strong>obj.post.foobar(...)</strong> 。这个调用不会阻塞。所以你也不用担心这里服务会挂起，因为别的消息进入改变了服务的内部状态。</p>
<h2 id="">热更新</h2>
<p>snax 是支持热更新的（只能热更新 snax 框架编写的 lua 服务）。但热更新更多的用途是做不停机的 bug 修复，不应用于常规的版本更新。所以，热更新的 api 被设计成下面这个样子。更适合打补丁。</p>
<p>你可以通过 <strong>snax.hotfix(obj, patchcode)</strong> 来向 obj 提交一个 patch 。</p>
<p>举个例子，你可以向上面列出的 pingserver 提交一个 patch ：</p>
<pre><code class="lang-lua">snax.hotfix(obj, <span class="hljs-string">[[

local i
local hello

function accept.hello()
    i = i + 1
    print ("fix", i, hello)
end

function hotfix(...)
    local temp = i
    i = 100
    return temp
end

]]</span>))
</code></pre>
<p>这样便改写了 accept.hello 方法。在 patch 中声明的 local i 和 local hello 在之前的版本中也有同名的 local 变量。
snax 的热更新机制会重新映射这些 local 变量。让 patch 中的新函数对应已有的 local 变量，所以你可以安全的继承服务的内部状态。</p>
<p>patch 中可以包含一个 <strong>function hotfix(...)</strong> 函数，在 patch 提交后立刻执行。这个函数可以用来查看或修改 snax 服务的线上状态（因为 local 变量会被关联）。hotfix 的函数返回值会传递给 snax.hotfix 的调用者。</p>
<p>所以，你也可以提交一个仅包含 hotfix 函数的 patch ，而不修改任何代码。这样的 patch 通常用于查看 snax 服务的内部状态（内部 local 变量的值），或用于修改它们。</p>
<p>注：不可以在 patch 中增加新的远程方法。</p>
<hr>
<p>test/testping.lua 是对 pingserver 的调用范例，你可以查看它加深理解。</p>
<p>snax 的实现分两部分：让服务工作起来的框架，实现在 service/snaxd.lua ；snax 的 api ，在 lualib/snax.lua 以及 lualib/snax/* 中。有兴趣的同学可以阅读源码。</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../skynetwiki/ShareData.html" class="navigation navigation-prev " aria-label="Previous page: ShareData"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../skynetwiki/SocketChannel.html" class="navigation navigation-next " aria-label="Next page: SocketChannel"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
